# mysql select æ‰§è¡Œè¿‡ç¨‹

## ä¸€æ¬¡ç®€å•MySQL selectçš„æ€»ä½“è¿‡ç¨‹

1. è¿æ¥å™¨
    1. å®¢æˆ·ç«¯è¿æ¥MySQLæœåŠ¡ï¼Œä¸€èˆ¬æ˜¯ä½¿ç”¨TCPè¿›è¡Œè¿æ¥çš„ï¼Œä¸‰æ¬¡æ¡æ‰‹
    2. ç»è¿‡TCPæ¡æ‰‹æˆåŠŸåï¼ŒéªŒè¯è´¦æˆ·å¯†ç ï¼Œ
    3. è¿æ¥å™¨ï¼ˆMySQL server å†…éƒ¨ï¼‰è·å–ç”¨æˆ·æƒé™å¹¶ç¼“å­˜æƒé™
2. æŸ¥è¯¢ç¼“å­˜ï¼ˆMySQL8å·²å¼ƒç”¨ï¼‰
    MySQL8å·²ç»åˆ äº†ï¼Œé¸¡è‚‹ï¼Œå› ä¸ºåªè¦è¡¨æ›´æ–°ç¼“å­˜å°±å¤±æ•ˆ
3. è§£æå™¨è§£æSQL
    è¯æ³•åˆ†æï¼Œè¯­æ³•åˆ†æï¼Œç”Ÿæˆè¯­æ³•æ ‘
4. é¢„å¤„ç†å™¨
    æ£€æŸ¥ SQL æŸ¥è¯¢è¯­å¥ä¸­çš„è¡¨æˆ–è€…å­—æ®µæ˜¯å¦å­˜åœ¨
    å°† select * ä¸­çš„ * ç¬¦å·ï¼Œæ‰©å±•ä¸ºè¡¨ä¸Šçš„æ‰€æœ‰åˆ—
5. ä¼˜åŒ–å™¨ï¼Œ
    è´Ÿè´£ç”Ÿæˆä¼˜åŒ–æ‰§è¡Œè®¡åˆ’ï¼Œä¹Ÿå°±æ˜¯è´Ÿè´£å°† SQL æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæ–¹æ¡ˆç¡®å®šä¸‹æ¥
    ä¾‹å¦‚ä¼šæ ¹æ®**ç´¢å¼•**ç­‰è¿›è¡Œè€ƒé‡ï¼Œä½¿ç”¨explainå¯ä»¥çœ‹åˆ°æ‰§è¡Œè®¡åˆ’
6. æ‰§è¡Œå™¨
    å’Œå­˜å‚¨å¼•æ“äº¤äº’ï¼Œä»å­˜å‚¨å¼•æ“è¯»å–è®°å½•ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯


## ä¿®æ”¹æƒé™ä¼šå½±å“å·²æœ‰è¿æ¥çš„æƒé™ä¹ˆï¼Ÿä¸ä¼š
å¦‚æœç”¨æˆ·å¯†ç éƒ½æ²¡æœ‰é—®é¢˜ï¼Œè¿æ¥å™¨å°±ä¼šè·å–è¯¥ç”¨æˆ·çš„æƒé™ï¼Œç„¶åä¿å­˜èµ·æ¥ï¼Œåç»­è¯¥ç”¨æˆ·åœ¨æ­¤è¿æ¥é‡Œçš„ä»»ä½•æ“ä½œï¼Œéƒ½ä¼šåŸºäºè¿æ¥å¼€å§‹æ—¶è¯»åˆ°çš„æƒé™è¿›è¡Œæƒé™é€»è¾‘çš„åˆ¤æ–­ã€‚æ‰€ä»¥ï¼Œå¦‚æœä¸€ä¸ªç”¨æˆ·å·²ç»å»ºç«‹äº†è¿æ¥ï¼Œå³ä½¿ç®¡ç†å‘˜ä¸­é€”ä¿®æ”¹äº†è¯¥ç”¨æˆ·çš„æƒé™ï¼Œä¹Ÿä¸ä¼šå½±å“å·²ç»å­˜åœ¨è¿æ¥çš„æƒé™ã€‚ä¿®æ”¹å®Œæˆåï¼Œåªæœ‰å†æ–°å»ºçš„è¿æ¥æ‰ä¼šä½¿ç”¨æ–°çš„æƒé™è®¾ç½®ã€‚

## å¦‚ä½•æŸ¥çœ‹ MySQL æœåŠ¡è¢«å¤šå°‘ä¸ªå®¢æˆ·ç«¯è¿æ¥äº†ï¼Ÿ
show processlist

## ç©ºé—²è¿æ¥ä¼šä¸€ç›´å ç”¨ç€å—ï¼Ÿ
ä¸æ˜¯ï¼ŒMySQL å®šä¹‰äº†ç©ºé—²è¿æ¥çš„æœ€å¤§ç©ºé—²æ—¶é•¿ï¼Œç”± wait_timeout å‚æ•°æ§åˆ¶çš„ï¼Œé»˜è®¤å€¼æ˜¯ 8 å°æ—¶ï¼ˆ28800 ç§’ï¼‰ï¼Œå¦‚æœç©ºé—²è¿æ¥è¶…è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œè¿æ¥å™¨å°±ä¼šè‡ªåŠ¨å°†å®ƒæ–­å¼€ã€‚
ä¸€ä¸ªå¤„äºç©ºé—²çŠ¶æ€çš„è¿æ¥è¢«æœåŠ¡ç«¯ä¸»åŠ¨æ–­å¼€åï¼Œè¿™ä¸ªå®¢æˆ·ç«¯å¹¶ä¸ä¼šé©¬ä¸ŠçŸ¥é“ï¼Œç­‰åˆ°å®¢æˆ·ç«¯åœ¨å‘èµ·ä¸‹ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼Œæ‰ä¼šæ”¶åˆ°è¿™æ ·çš„æŠ¥é”™â€œERROR 2013 (HY000): Lost connection to MySQL server during queryâ€ã€‚



##  MySQL çš„è¿æ¥æ•°æœ‰é™åˆ¶å—ï¼Ÿ
MySQL æœåŠ¡æ”¯æŒçš„æœ€å¤§è¿æ¥æ•°ç”± max_connections å‚æ•°æ§åˆ¶ï¼Œæ¯”å¦‚æˆ‘çš„ MySQL æœåŠ¡é»˜è®¤æ˜¯ 151 ä¸ªï¼Œè¶…è¿‡è¿™ä¸ªå€¼ï¼Œç³»ç»Ÿå°±ä¼šæ‹’ç»æ¥ä¸‹æ¥çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶æŠ¥é”™æç¤ºâ€œToo many connectionsâ€ã€‚

## MySQLé•¿çŸ­è¿æ¥çš„åŒºåˆ«
```text
// çŸ­è¿æ¥
è¿æ¥ mysql æœåŠ¡ï¼ˆTCP ä¸‰æ¬¡æ¡æ‰‹ï¼‰
æ‰§è¡Œsql
æ–­å¼€ mysql æœåŠ¡ï¼ˆTCP å››æ¬¡æŒ¥æ‰‹ï¼‰

// é•¿è¿æ¥
è¿æ¥ mysql æœåŠ¡ï¼ˆTCP ä¸‰æ¬¡æ¡æ‰‹ï¼‰
æ‰§è¡Œsql
æ‰§è¡Œsql
æ‰§è¡Œsql
....
æ–­å¼€ mysql æœåŠ¡ï¼ˆTCP å››æ¬¡æŒ¥æ‰‹ï¼‰
```

## é•¿è¿æ¥ä¼˜ç‚¹ç¼ºç‚¹
å¥½å¤„å°±æ˜¯å¯ä»¥å‡å°‘å»ºç«‹è¿æ¥å’Œæ–­å¼€è¿æ¥çš„è¿‡ç¨‹
åå¤„æ˜¯é•¿è¿æ¥åå¯èƒ½ä¼šå ç”¨å†…å­˜å¢å¤šï¼Œå› ä¸º MySQL åœ¨æ‰§è¡ŒæŸ¥è¯¢è¿‡ç¨‹ä¸­ä¸´æ—¶ä½¿ç”¨å†…å­˜ç®¡ç†è¿æ¥å¯¹è±¡ï¼Œè¿™äº›è¿æ¥å¯¹è±¡èµ„æºåªæœ‰åœ¨è¿æ¥æ–­å¼€æ—¶æ‰ä¼šé‡Šæ”¾ã€‚å¦‚æœé•¿è¿æ¥ç´¯è®¡å¾ˆå¤šï¼Œå°†å¯¼è‡´ MySQL æœåŠ¡å ç”¨å†…å­˜å¤ªå¤§ï¼Œæœ‰å¯èƒ½ä¼šè¢«ç³»ç»Ÿå¼ºåˆ¶æ€æ‰ï¼Œè¿™æ ·ä¼šå‘ç”Ÿ MySQL æœåŠ¡å¼‚å¸¸é‡å¯çš„ç°è±¡

## æ€ä¹ˆè§£å†³é•¿è¿æ¥å ç”¨å†…å­˜çš„é—®é¢˜
ç¬¬ä¸€ç§ï¼Œå®šæœŸæ–­å¼€é•¿è¿æ¥ã€‚
ç¬¬äºŒç§ï¼Œå®¢æˆ·ç«¯ä¸»åŠ¨é‡ç½®è¿æ¥ã€‚MySQL 5.7 ç‰ˆæœ¬å®ç°äº† mysql_reset_connection() å‡½æ•°çš„æ¥å£ï¼Œæ³¨æ„è¿™æ˜¯æ¥å£å‡½æ•°ä¸æ˜¯å‘½ä»¤ï¼Œé‚£ä¹ˆå½“å®¢æˆ·ç«¯æ‰§è¡Œäº†ä¸€ä¸ªå¾ˆå¤§çš„æ“ä½œåï¼Œåœ¨ä»£ç é‡Œè°ƒç”¨ mysql_reset_connection å‡½æ•°æ¥é‡ç½®è¿æ¥ï¼Œè¾¾åˆ°é‡Šæ”¾å†…å­˜çš„æ•ˆæœã€‚è¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦é‡è¿å’Œé‡æ–°åšæƒé™éªŒè¯ï¼Œä½†æ˜¯ä¼šå°†è¿æ¥æ¢å¤åˆ°åˆšåˆšåˆ›å»ºå®Œæ—¶çš„çŠ¶æ€ã€‚

# äº‹åŠ¡
## äº‹åŠ¡çš„ç‰¹æ€§

åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨ä¸å®Œæˆï¼Œè€Œä¸”äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æˆ–è€…å–æ¶ˆï¼Œä¼šè¢«å›æ»šåˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ã€‚
ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šæ˜¯æŒ‡äº‹åŠ¡æ“ä½œå‰å’Œæ“ä½œåï¼Œæ•°æ®æ»¡è¶³å®Œæ•´æ€§çº¦æŸï¼Œæ•°æ®åº“ä¿æŒä¸€è‡´æ€§çŠ¶æ€ï¼ˆå’Œä¸šåŠ¡æœ‰å…³ï¼‰ã€‚
éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šå¤šä¸ªäº‹åŠ¡åŒæ—¶ä½¿ç”¨ç›¸åŒçš„æ•°æ®æ—¶ï¼Œä¸ä¼šç›¸äº’å¹²æ‰°ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½æœ‰ä¸€ä¸ªå®Œæ•´çš„æ•°æ®ç©ºé—´ï¼Œå¯¹å…¶ä»–å¹¶å‘äº‹åŠ¡æ˜¯éš”ç¦»çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¶ˆè´¹è€…è´­ä¹°å•†å“è¿™ä¸ªäº‹åŠ¡ï¼Œæ˜¯ä¸å½±å“å…¶ä»–æ¶ˆè´¹è€…è´­ä¹°çš„ã€‚
æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šäº‹åŠ¡å¤„ç†ç»“æŸåï¼Œå°±åº”è¯¥è¢«æŒä¹…åŒ–åˆ°ç£ç›˜
Cæ˜¯é€šè¿‡AIDå®ç°çš„

## InnoDB å¼•æ“é€šè¿‡ä»€ä¹ˆæŠ€æœ¯æ¥ä¿è¯äº‹åŠ¡çš„è¿™å››ä¸ªç‰¹æ€§

æŒä¹…æ€§æ˜¯é€šè¿‡ redo log ï¼ˆé‡åšæ—¥å¿—ï¼‰æ¥ä¿è¯çš„ï¼›
åŸå­æ€§æ˜¯é€šè¿‡ undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰ æ¥ä¿è¯çš„ï¼›
éš”ç¦»æ€§æ˜¯é€šè¿‡ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ æˆ–é”æœºåˆ¶æ¥ä¿è¯çš„ï¼›
ä¸€è‡´æ€§åˆ™æ˜¯é€šè¿‡æŒä¹…æ€§+åŸå­æ€§+éš”ç¦»æ€§æ¥ä¿è¯ï¼›


## æ ‡å‡†SQLçš„éš”ç¦»çº§åˆ«

ä¸¥é‡æ€€ç–‘xiaolincodingçš„è¡¨è¿°æœ‰è¯¯
è¯»æœªæäº¤ï¼ˆread uncommittedï¼‰ï¼ŒæŒ‡ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æ—¶ï¼Œå®ƒåšçš„å˜æ›´å°±èƒ½è¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ï¼›
ï¼ˆread committedï¼‰ï¼ŒæŒ‡ä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åï¼Œå®ƒåšçš„å˜æ›´æ‰èƒ½è¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ï¼›
å¯é‡å¤è¯»ï¼ˆrepeatable readï¼‰ï¼ŒæŒ‡ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®ï¼Œè·Ÿç¬¬ä¸€æ¬¡è¯»å–æ—¶çœ‹åˆ°çš„æ˜¯ä¸€è‡´çš„ï¼›
ä¸²è¡ŒåŒ–ï¼ˆserializable ï¼‰ï¼›äº‹åŠ¡å°±åƒæ˜¯ä¾æ¬¡ã€ä¸²è¡Œåœ°æŒ‰ç…§æäº¤é¡ºåºæ‰§è¡Œï¼Œè€Œä¸æ˜¯å¹¶å‘æ‰§è¡Œä¸€æ ·

å…¶å®çœ‹https://www.postgresql.org/docs/current/transaction-iso.htmlï¼Œä¸²è¡ŒåŒ–å¯èƒ½ä¹Ÿæ˜¯æœ‰é—®é¢˜çš„

## MySQLéš”ç¦»çº§åˆ«
MySQLå®ç°äº†æ ‡å‡†SQLçš„éš”ç¦»çº§åˆ«ï¼Œä½†æ˜¯ç•¥æœ‰åŒºåˆ«
MySQL åœ¨ã€Œå¯é‡å¤è¯»ã€éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šé¿å…å¹»è¯»ç°è±¡çš„å‘ç”Ÿ
MySQLçš„ä¸²è¡ŒåŒ–æ€§èƒ½å¾ˆå·®ï¼ŒMySQL åœ¨ SERIALIZABLE ä¸‹ä¼šå¼ºåˆ¶æ‰€æœ‰è¯»éƒ½åŠ å…±äº«é”ï¼ˆSé”ï¼‰ï¼›æ‰€æœ‰å†™éƒ½åŠ æ’ä»–é”ï¼ˆXé”ï¼‰ï¼›æ˜¯é€šè¿‡ æ‚²è§‚é”æœºåˆ¶ æ¥é˜²æ­¢å¹¶å‘å†²çªï¼›ä¸€æ—¦æœ‰è¯»å†™å†²çªæ—¶ï¼Œäº‹åŠ¡ä¼šé˜»å¡ï¼Œå¹¶å‘æ€§èƒ½å¾ˆå·®ã€‚

1. è¯»æœªæäº¤ï¼šæ¯æ¬¡éƒ½è¯»æœ€æ–°çš„å°±å¥½äº†
2. ä¸²è¡ŒåŒ–ï¼šå¼ºåˆ¶æ‰€æœ‰è¯»éƒ½åŠ å…±äº«é”ï¼ˆSé”ï¼‰ï¼Œæ‰€æœ‰å†™éƒ½åŠ æ’ä»–é”ï¼ˆXé”ï¼‰
3. è¯»æäº¤ï¼š Read View å®ç°çš„ï¼Œã€Œæ¯ä¸ªè¯­å¥æ‰§è¡Œå‰ã€éƒ½ä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ª Read View
4. å¯é‡å¤è¯»ï¼šRead View å®ç°çš„ï¼Œå¯åŠ¨äº‹åŠ¡æ—¶ã€ç”Ÿæˆä¸€ä¸ª Read Viewï¼Œç„¶åæ•´ä¸ªäº‹åŠ¡æœŸé—´éƒ½åœ¨ç”¨è¿™ä¸ª Read View

æ³¨æ„ï¼Œæ‰§è¡Œã€Œbegin/start transactionã€å‘½ä»¤ï¼Œå¹¶ä¸æ„å‘³ç€å¯åŠ¨äº†äº‹åŠ¡ï¼Œé»˜è®¤æ‰§è¡Œäº†ç¬¬ä¸€æ¡ select è¯­å¥ï¼Œæ‰æ˜¯äº‹åŠ¡çœŸæ­£å¯åŠ¨çš„æ—¶æœºã€‚
æ‰§è¡Œ start transaction with consistent snapshot å‘½ä»¤ï¼Œæ‰é©¬ä¸Šå¯åŠ¨äº‹åŠ¡ã€‚

## mvcc


# é”

## å…¨å±€é”

`flush tables with read lock`ï¼Œæ‰§è¡Œåï¼Œæ•´ä¸ªæ•°æ®åº“å°±å¤„äºåªè¯»çŠ¶æ€äº†ã€‚

å¯¹æ•°æ®çš„å¢åˆ æ”¹æ“ä½œï¼Œæ¯”å¦‚ insertã€deleteã€updateç­‰ï¼›
å¯¹è¡¨ç»“æ„çš„æ›´æ”¹æ“ä½œï¼Œæ¯”å¦‚ alter tableã€drop table ç­‰éƒ½ä¼šè¢«é˜»å¡ã€‚

`unlock tables`è§£é”ï¼Œè¿æ¥æ–­å¼€ä¹Ÿä¼šè‡ªåŠ¨é‡Šæ”¾

å…¨å±€é”ä¸»è¦åº”ç”¨äºåšå…¨åº“é€»è¾‘å¤‡ä»½ï¼Œé˜²æ­¢å› ä¸ºæ•°æ®æˆ–è¡¨ç»“æ„çš„æ›´æ–°ï¼Œè€Œå‡ºç°å¤‡ä»½æ–‡ä»¶çš„æ•°æ®ä¸é¢„æœŸçš„ä¸ä¸€æ ·ã€‚

### å¦‚ä½•é¿å…å…¨å±€é”æœŸé—´ä¸šåŠ¡åœæ»

å…¨å±€é”æœŸé—´ï¼Œä¸šåŠ¡åªèƒ½è¯»æ•°æ®ï¼Œè€Œä¸èƒ½æ›´æ–°æ•°æ®ï¼Œè¿™æ ·ä¼šé€ æˆä¸šåŠ¡åœæ»ã€‚

å¦‚æœæ•°æ®åº“çš„å¼•æ“æ”¯æŒçš„äº‹åŠ¡æ”¯æŒ**å¯é‡å¤è¯»**çš„éš”ç¦»çº§åˆ«ï¼Œé‚£ä¹ˆåœ¨å¤‡ä»½æ•°æ®åº“ä¹‹å‰å…ˆ**å¼€å¯äº‹åŠ¡**ï¼Œä¼šå…ˆåˆ›å»º Read Viewï¼Œç„¶åæ•´ä¸ªäº‹åŠ¡æ‰§è¡ŒæœŸé—´éƒ½åœ¨ç”¨è¿™ä¸ª Read Viewï¼Œè€Œä¸”ç”±äº **MVCC** çš„æ”¯æŒï¼Œå¤‡ä»½æœŸé—´ä¸šåŠ¡ä¾ç„¶å¯ä»¥å¯¹æ•°æ®è¿›è¡Œæ›´æ–°æ“ä½œã€‚ 

å¦‚`mysqldump`ï¼Œåœ¨ä½¿ç”¨ `mysqldump` æ—¶åŠ ä¸Š `â€“single-transaction` å‚æ•°çš„æ—¶å€™ï¼Œå°±ä¼šåœ¨å¤‡ä»½æ•°æ®åº“ä¹‹å‰å…ˆå¼€å¯äº‹åŠ¡ã€‚è¿™ç§æ–¹æ³•åªé€‚ç”¨äºæ”¯æŒã€Œ**å¯é‡å¤è¯»**éš”ç¦»çº§åˆ«çš„äº‹åŠ¡ã€çš„å­˜å‚¨å¼•æ“ã€‚

## è¡¨é”

### è¯»é”
lock tables t_student read;

è¡¨çº§åˆ«çš„å…±äº«é”ï¼Œä¹Ÿå°±æ˜¯è¯»é”ï¼Œå…è®¸å½“å‰ä¼šè¯è¯»å–è¢«é”å®šçš„è¡¨ï¼Œä½†é˜»æ­¢å…¶ä»–ä¼šè¯å¯¹è¿™äº›è¡¨è¿›è¡Œå†™æ“ä½œï¼š

è¯»é”é™åˆ¶äº†åˆ«çš„çº¿ç¨‹å†™ï¼Œå…¶ä»–çº¿ç¨‹å†™ä¼šå µå¡ã€‚

è¯»é”ä¹Ÿä¼šé™åˆ¶æœ¬çº¿ç¨‹å¯¹è¿™ä¸ªè¡¨çš„å†™å…¥ï¼Œå†™å…¥çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚

è¯»é”é™åˆ¶æœ¬çº¿ç¨‹ä¸èƒ½è®¿é—®å…¶ä»–è¡¨ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œé™¤éå…¶ä»–è¡¨ä¹Ÿè¢«é”äº†ï¼Œå¦‚LOCK TABLES table1 READ, table2 READ, table3 READ;

äº‹åŠ¡å’Œè¡¨é”ä¸å…¼å®¹

é‡Šæ”¾è¯»é”ï¼šunlock tablesæˆ–è€…é€€å‡ºä¼šè¯ï¼Œæˆ–è€…åœ¨æ‰§è¡Œæ–°çš„ LOCK TABLES å‰ï¼Œæ—§çš„é”ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ã€‚

### å†™é”
lock tables t_stuent write;

è¡¨çº§åˆ«çš„ç‹¬å é”ï¼Œä¹Ÿå°±æ˜¯å†™é”ï¼Œå…è®¸å½“å‰ä¼šè¯å¯¹è¡¨è¿›è¡Œè¯»å†™æ“ä½œï¼Œä½†é˜»æ­¢å…¶ä»–ä¼šè¯å¯¹è¿™äº›è¡¨è¿›è¡Œä»»ä½•æ“ä½œï¼ˆè¯»æˆ–å†™ï¼‰ï¼š

è¯»é”é™åˆ¶äº†åˆ«çš„çº¿ç¨‹è¯»å†™ï¼Œå…¶ä»–çº¿ç¨‹è¯»å†™ä¼šå µå¡ã€‚

è¯»é”é™åˆ¶æœ¬çº¿ç¨‹ä¸èƒ½è®¿é—®å…¶ä»–è¡¨ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œé™¤éå…¶ä»–è¡¨ä¹Ÿè¢«é”äº†ï¼Œå¦‚LOCK TABLES table1 READ, table2 READ, table3 READ;

äº‹åŠ¡å’Œè¡¨é”ä¸å…¼å®¹

é‡Šæ”¾è¯»é”ï¼šunlock tablesæˆ–è€…é€€å‡ºä¼šè¯ï¼Œæˆ–è€…åœ¨æ‰§è¡Œæ–°çš„ LOCK TABLES å‰ï¼Œæ—§çš„é”ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ã€‚

### å…ƒæ•°æ®é”MDL

å…ƒæ•°æ®é”æ˜¯ä¸ºäº†ä¿è¯å½“ç”¨æˆ·å¯¹è¡¨æ‰§è¡Œ CRUD æ“ä½œæ—¶ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹å¯¹è¿™ä¸ªè¡¨ç»“æ„åšäº†å˜æ›´ã€‚

æ— éœ€ç›´æ¥ä½¿ç”¨ï¼Œå¯¹æ•°æ®åº“è¡¨è¿›è¡Œæ“ä½œæ—¶ï¼Œä¼šè‡ªåŠ¨ç»™è¿™ä¸ªè¡¨åŠ ä¸Š MDLï¼š

* å¯¹ä¸€å¼ è¡¨è¿›è¡Œ CRUD æ“ä½œæ—¶ï¼ŒåŠ çš„æ˜¯ MDL è¯»é”ï¼›
* å¯¹ä¸€å¼ è¡¨åšç»“æ„å˜æ›´æ“ä½œçš„æ—¶å€™ï¼ŒåŠ çš„æ˜¯ MDL å†™é”ï¼›

MDL æ˜¯åœ¨äº‹åŠ¡æäº¤åæ‰ä¼šé‡Šæ”¾

#### é•¿äº‹åŠ¡å¯¹MDLçš„å½±å“

ç”³è¯· MDL é”çš„æ“ä½œä¼šå½¢æˆä¸€ä¸ªé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­å†™é”è·å–ä¼˜å…ˆçº§é«˜äºè¯»é”ï¼Œä¸€æ—¦å‡ºç° MDL å†™é”ç­‰å¾…ï¼Œä¼šé˜»å¡åç»­è¯¥è¡¨çš„æ‰€æœ‰ CRUD æ“ä½œã€‚

ä¸¾ä¾‹è€Œè¨€ï¼š
é¦–å…ˆï¼Œçº¿ç¨‹ A å…ˆå¯ç”¨äº†äº‹åŠ¡ï¼ˆä½†æ˜¯ä¸€ç›´ä¸æäº¤ï¼‰ï¼Œç„¶åæ‰§è¡Œä¸€æ¡ select è¯­å¥ï¼Œæ­¤æ—¶å°±å…ˆå¯¹è¯¥è¡¨åŠ ä¸Š MDL è¯»é”ï¼›

ç„¶åï¼Œçº¿ç¨‹ B ä¹Ÿæ‰§è¡Œäº†åŒæ ·çš„ select è¯­å¥ï¼Œæ­¤æ—¶å¹¶ä¸ä¼šé˜»å¡ï¼Œå› ä¸ºã€Œè¯»è¯»ã€å¹¶ä¸å†²çªï¼›

æ¥ç€ï¼Œçº¿ç¨‹ C ä¿®æ”¹äº†è¡¨å­—æ®µï¼Œæ­¤æ—¶ç”±äºçº¿ç¨‹ A çš„äº‹åŠ¡å¹¶æ²¡æœ‰æäº¤ï¼Œä¹Ÿå°±æ˜¯ MDL è¯»é”è¿˜åœ¨å ç”¨ç€ï¼Œè¿™æ—¶çº¿ç¨‹ C å°±æ— æ³•ç”³è¯·åˆ° MDL å†™é”ï¼Œå°±ä¼šè¢«é˜»å¡ï¼Œ

åœ¨Cä¹‹åçš„æ‰€æœ‰MDLè¯»é”éƒ½ä¼šè¢«é˜»å¡ï¼Œå› ä¸ºå†™é”çš„ä¼˜å…ˆçº§é«˜ï¼Œä½†æ˜¯Cçš„å†™é”è¢«Açš„é•¿äº‹åŠ¡å ç”¨äº†ã€‚

### æ„å‘é”

å‚è€ƒhttps://zhuanlan.zhihu.com/p/185003485

ç®€å•è€Œè¨€ï¼Œæ„å‘é”æ˜¯InnoDBè‡ªèº«ä¸€ç§å†…éƒ¨ä¼˜åŒ–ï¼Œç”¨äºåœ¨åŠ è¡¨é”ä¹‹å‰åˆ¤æ–­è¿™ä¸ªè¡¨æ˜¯å¦å·²ç»æœ‰è¡Œé”ã€‚

æ¯æ¬¡åŠ å…¥è¡Œé”çš„æ—¶å€™ï¼ŒInnoDBéƒ½ä¼šè‡ªåŠ¨åŠ å…¥æ„å‘é”ï¼ˆè¡¨é”ï¼‰ï¼Œæ‰€æœ‰åœ¨åŠ çœŸçš„è¡¨é”ï¼ˆè¯»å†™é”ï¼‰çš„æ—¶å€™ï¼Œé€šè¿‡åˆ¤æ–­æœ‰æ— æ„å‘é”å°±çŸ¥é“æ˜¯å¦éœ€è¦é˜»å¡äº†ã€‚

### AUTO-INC é”

AUTO-INC é”æ˜¯ç‰¹æ®Šçš„è¡¨é”æœºåˆ¶ï¼Œåœ¨æ’å…¥æ•°æ®æ—¶ï¼Œä¼šåŠ ä¸€ä¸ªè¡¨çº§åˆ«çš„ AUTO-INC é”ï¼Œç„¶åä¸ºè¢« AUTO_INCREMENT ä¿®é¥°çš„å­—æ®µèµ‹å€¼é€’å¢çš„å€¼ï¼Œç­‰æ’å…¥è¯­å¥æ‰§è¡Œå®Œæˆåï¼Œæ‰ä¼šæŠŠ AUTO-INC é”é‡Šæ”¾æ‰ã€‚

é”ä¸æ˜¯å†ä¸€ä¸ªäº‹åŠ¡æäº¤åæ‰é‡Šæ”¾ï¼Œè€Œæ˜¯å†**æ‰§è¡Œå®Œæ’å…¥è¯­å¥**åå°±ä¼š**ç«‹å³é‡Šæ”¾**ã€‚

æ˜¾ç„¶ï¼Œå¯¹äºä¸€ä¸ªè¡¨çš„æ’å…¥éƒ½æ˜¯ä¾èµ–äºè¿™ä¸ªé”çš„ï¼Œå› æ­¤å¤§é‡æ’å…¥ä¼šå½±å“æ€§èƒ½ã€‚

å› æ­¤ç°åœ¨çš„MySQLæœ‰äº†ä¸€ä¸ªå¯é€‰çš„ä¼˜åŒ–innodb_autoinc_lock_mode ï¼š
åœ¨æ’å…¥æ•°æ®çš„æ—¶å€™ï¼Œä¼šä¸ºè¢« AUTO_INCREMENT ä¿®é¥°çš„å­—æ®µåŠ ä¸Šè½»é‡çº§é”ï¼Œç„¶åç»™è¯¥**å­—æ®µ**èµ‹å€¼ä¸€ä¸ªè‡ªå¢çš„å€¼ï¼Œå°±æŠŠè¿™ä¸ªè½»é‡çº§é”é‡Šæ”¾äº†ï¼Œè€Œä¸éœ€è¦ç­‰å¾…æ•´ä¸ªæ’å…¥è¯­å¥æ‰§è¡Œå®Œåæ‰é‡Šæ”¾é”ã€‚

çœ‹åˆ°åŒºåˆ«äº†æ²¡æœ‰ï¼Œä¸ç”¨å®Œæˆä¸€ä¸ªæ’å…¥ï¼Œåªéœ€è¦ç»™å­—æ®µèµ‹å€¼å°±é‡Šæ”¾äº†ï¼Œä¼šæ¯”ä¹‹å‰æ€§èƒ½å¥½å¾ˆå¤šã€‚ç¼ºç‚¹æ˜¯å¹¶å‘å¤§çš„æ—¶å€™å¯èƒ½ä¼šå‡ºç°äº¤é”™çš„IDï¼Œä¹Ÿå°±æ˜¯**ä¸ä¿è¯è¿ç»­**ã€‚

innodb_autoinc_lock_mode =0ï¼Œä¼ ç»Ÿé”æ¨¡å¼ï¼ˆlegacyï¼‰ï¼Œæ‰€æœ‰çš„æ’å…¥éƒ½ä½¿ç”¨AUTO_INCè¡¨çº§é”
innodb_autoinc_lock_mode =1ï¼Œè¿ç»­é”æ¨¡å¼ï¼Œå¯¹äºâ€œSimple insertsâ€ä½¿ç”¨è½»é‡äº’æ–¥é”ï¼Œå¯¹äºâ€œbulk insertsâ€ç±»è¯­å¥ä½¿ç”¨AUTO_INCè¡¨çº§é”ã€‚ä¸»ä»å¤åˆ¶å¯ä»¥ä¿è¯ä¸€è‡´ï¼ˆç®€å•è€Œè¨€ï¼Œå› ä¸ºé”çš„å­˜åœ¨ï¼Œä¸€æ¡è¯­å¥æ‰§è¡Œçš„ç»“æœIDå¿…ç„¶æ˜¯è¿ç»­çš„ï¼Œbinlogä¹Ÿæ˜¯æŒ‰é¡ºåºè®°å½•çš„ï¼Œæ‰€ä»¥å¤åˆ¶åä¹Ÿå¿…ç„¶è¿ç»­ï¼‰ã€‚
innodb_autoinc_lock_mode =2ï¼Œäº¤é”™é”æ¨¡å¼(MySQL8é»˜è®¤) ï¼Œæ‰€æœ‰çš„insertéƒ½ç”¨è½»é‡çº§é”ã€‚ç¼ºç‚¹ï¼šåŸºäºè¯­å¥å¤åˆ¶ä¼šæœ‰é—®é¢˜ï¼Œåªèƒ½ä½¿ç”¨åŸºäºROWå¤åˆ¶ï¼ˆMySQL8é»˜è®¤ï¼‰ã€‚

æ³¨ï¼šhttps://dev.mysql.com/doc/refman/8.0/en/innodb-auto-increment-handling.html
â€œSimple insertsâ€ï¼šæŒ‡åœ¨æ’å…¥å‰å°±èƒ½ç¡®å®šæ’å…¥è¡Œæ•°çš„è¯­å¥ï¼ŒåŒ…æ‹¬ï¼šINSERTã€REPLACEï¼Œä¸åŒ…å«INSERTâ€¦ON DUPLICATE KEY UPDATEè¿™ç±»è¯­å¥ã€‚

â€œBulk insertsâ€ï¼šæŒ‡åœ¨æ’å…¥å‰ä¸èƒ½ç¡®å®šè¡Œæ•°çš„è¯­å¥ï¼ŒåŒ…æ‹¬ï¼šINSERT ... SELECT/REPLACE ... SELECT/LOAD DATAã€‚

## è¡Œé”
TODOï¼šè¿™é‡Œæ•´ç†çš„æ¯”è¾ƒçƒ‚

InnoDB æ”¯æŒè¡Œé”ï¼Œ MyISAM ä¸æ”¯æŒ

```
//å¯¹è¯»å–çš„è®°å½•åŠ å…±äº«é”
select ... lock in share mode;

//å¯¹è¯»å–çš„è®°å½•åŠ ç‹¬å é”
select ... for update;
```
è¡Œçº§é”çš„ç±»å‹ä¸»è¦æœ‰ä¸‰ç±»ï¼š

1. Record Lockï¼Œè®°å½•é”ï¼Œä¹Ÿå°±æ˜¯ä»…ä»…æŠŠä¸€æ¡è®°å½•é”ä¸Šï¼›
2. Gap Lockï¼Œé—´éš™é”ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œä½†æ˜¯ä¸åŒ…å«è®°å½•æœ¬èº«ï¼›
3. Next-Key Lockï¼šRecord Lock + Gap Lock çš„ç»„åˆï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œå¹¶ä¸”é”å®šè®°å½•æœ¬èº«

### Record Lockï¼ˆè®°å½•é”ï¼‰
é”ä½çš„æ˜¯ä¸€æ¡è®°å½•ã€‚è€Œä¸”è®°å½•é”æ˜¯æœ‰ S é”å’Œ X é”ä¹‹åˆ†çš„

### Gap Lockï¼ˆé—´éš™é”ï¼‰

**åªå­˜åœ¨äºå¯é‡å¤è¯»éš”ç¦»çº§åˆ«**ï¼Œç›®çš„æ˜¯ä¸ºäº†è§£å†³å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹**å¹»è¯»**çš„ç°è±¡ã€‚

é—´éš™é”æ˜¯å¯¹ä¸€ä¸ªç´¢å¼•å€¼ä¹‹é—´çš„â€œé—´éš™â€åŠ é”ï¼Œè€Œä¸æ˜¯å¯¹å…·ä½“çš„æŸä¸€è¡Œæ•°æ®åŠ é”ã€‚é˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¿™ä¸ªâ€œé—´éš™â€ä¸­æ’å…¥æ–°çš„è®°å½•ã€‚ä¿è¯å½“å‰äº‹åŠ¡åœ¨æ‰§è¡ŒæœŸé—´ä¸ä¼šçœ‹åˆ°æ–°å¢çš„â€œå¹»å½±è¡Œâ€ã€‚

å‡è®¾æ•°æ®åº“é‡Œæœ‰1ï¼Œ3ï¼Œ5è¿™ä¸‰æ¡å…ƒç´ 

```
INSERT INTO t VALUES (1, 'Alice'), (3, 'Bob'), (5, 'Charlie');
START TRANSACTION;
SELECT * FROM t WHERE id BETWEEN 2 AND 4 FOR UPDATE;
```
è¿™ä¸ªæŸ¥è¯¢ä¼šé”å®šç´¢å¼•ä¸­ id åœ¨ 2 åˆ° 4 ä¹‹é—´çš„æ‰€æœ‰è®°å½•å’Œé—´éš™ ï¼Œå³ï¼š 

é”å®š id=3 è¿™ä¸€è¡Œï¼ˆrecord lockï¼‰
é”å®š (1,3) å’Œ (3,5) ä¹‹é—´çš„é—´éš™ï¼ˆgap lockï¼‰
å°è¯•å¯¹è¢«é”å®šçš„è®°å½•å’Œé—´éš™è¿›è¡Œä¿®æ”¹ä¼šè¢«é˜»å¡

https://blog.csdn.net/Tomwildboar/article/details/134342139

### Next-Key Lock

InnoDB ä¸ºäº†æ”¯æŒ å¯é‡å¤è¯» äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œåœ¨æ‰§è¡ŒèŒƒå›´æŸ¥è¯¢ï¼ˆå¦‚ SELECT ... WHERE age > 10 AND age < 20 FOR UPDATEï¼‰æ—¶åŠ ä¸Šçš„ä¸€ç§é”ï¼Œé˜²æ­¢å¹»è¯»ã€‚

åœ¨ REPEATABLE READ éš”ç¦»çº§åˆ«ä¸‹ï¼ŒèŒƒå›´æŸ¥è¯¢ + FOR UPDATE / LOCK IN SHARE MODE å°±ä¼šè§¦å‘ Next-Key Lock

ä¸ºä»€ä¹ˆå« â€œNext-Keyâ€ï¼Ÿå› ä¸ºå®ƒé”çš„æ˜¯ï¼š å½“å‰è®°å½• + å®ƒå‰é¢çš„é—´éš™ï¼Œç›¸å½“äºå·¦å¼€å³é—­åŒºé—´

ä¸¾ä¸ªç®€å•çš„ä¾‹å­

```
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  age INT,
  name VARCHAR(100)
) ENGINE=InnoDB;

-- æ•°æ®ï¼š
+----+-----+
| id | age |
+----+-----+
| 1  | 10  |
| 2  | 20  |
| 3  | 30  |
+----+-----+
```

```
START TRANSACTION;
SELECT * FROM users WHERE age > 10 AND age < 30 FOR UPDATE;
```
InnoDB é‡‡ç”¨ Next-Key Lockï¼Œä¼šåŠ é”ï¼š(10, 20]å’Œ(20, 30]ï¼Œ
ä¸è®©å…¶ä»–äº‹åŠ¡åœ¨è¿™äº›é—´éš™ä¸­æ’å…¥æ–°æ•°æ®ï¼Œä»¥é˜²å¹»è¯»

* ä¸€ä¸ªæ›´å…·ä½“çš„ä¾‹å­ï¼ŒGPTå‘Šè¯‰æˆ‘çš„ï¼Œæ²¡æœ‰åšå®éªŒéªŒè¯
æˆ‘ä»¬ç”¨å¦‚ä¸‹è¡¨ç»“æ„å’Œæ•°æ®ä¸ºä¾‹ï¼š
```
CREATE TABLE t (
  id INT PRIMARY KEY,
  age INT,
  name VARCHAR(20),
  KEY(age) -- æ™®é€šç´¢å¼•
) ENGINE=InnoDB;

-- åˆå§‹æ•°æ®ï¼š
INSERT INTO t VALUES 
(1, 10, 'A'),
(2, 20, 'B'),
(3, 30, 'C'),
(4, 40, 'D');
```


1. ç¤ºä¾‹ 1ï¼šèŒƒå›´æŸ¥è¯¢ + FOR UPDATEï¼ˆNext-Key Lockï¼‰
```
-- äº‹åŠ¡A
START TRANSACTION;
SELECT * FROM t WHERE age > 10 AND age < 40 FOR UPDATE;
```
ğŸ”’ åŠ é”æƒ…å†µï¼ˆNext-Key Lockï¼‰ï¼š

    (10,20]ï¼šé”ä½ gap å’Œ age=20

    (20,30]ï¼šé”ä½ gap å’Œ age=30

    (30,40]ï¼šé”ä½ gap å’Œ age=40

å…±é”ä½ï¼šä¸‰æ®µèŒƒå›´å’Œä¸‰ä¸ªè®°å½•


2. ç¤ºä¾‹ 2ï¼šç²¾ç¡®æŸ¥æ‰¾å”¯ä¸€ä¸»é”®ï¼ˆRecord Lockï¼‰

```
-- äº‹åŠ¡A
START TRANSACTION;
SELECT * FROM t WHERE id = 2 FOR UPDATE;

```

è¿™æ˜¯ä¸»é”®æŸ¥è¯¢ï¼ˆå”¯ä¸€ç´¢å¼• + ç²¾ç¡®åŒ¹é…ï¼‰
ğŸ”’ åŠ é”æƒ…å†µï¼š

    ä»…åŠ  Record Lockï¼šid = 2

ä¸ä¼šåŠ é—´éš™é”ï¼Œä¸å½±å“å…¶ä»–è®°å½•æ’å…¥ã€‚

3. ç¤ºä¾‹ 3ï¼šéå”¯ä¸€ç´¢å¼•æŸ¥æ‰¾ + ç­‰å€¼ï¼ˆNext-Key Lockï¼‰

-- äº‹åŠ¡A
START TRANSACTION;
SELECT * FROM t WHERE age = 30 FOR UPDATE;

age æ˜¯æ™®é€šäºŒçº§ç´¢å¼•ï¼ˆéå”¯ä¸€ï¼‰ï¼Œå³ä½¿æ˜¯ç­‰å€¼ï¼Œä¹Ÿä¼šè§¦å‘ Next-Key Lockã€‚
ğŸ”’ åŠ é”æƒ…å†µï¼š

    (20,30]ï¼šé”ä½ age=30 å’Œå‰é—´éš™ï¼ˆå› ä¸ºInnoDBä¸­æ²¡æœ‰(30,30]è¿™ç§èŒƒå›´ï¼‰

âš ï¸ è™½ç„¶æ˜¯ç­‰å€¼æŸ¥æ‰¾ï¼Œä½†ä»ç„¶æ˜¯èŒƒå›´æ‰«æï¼ˆç›¸å½“äºage >= 30 AND age <= 30ï¼‰ â†’ ç”¨ Next-Key Lockï¼


4. ç¤ºä¾‹ 4ï¼šæ²¡æœ‰ç”¨ç´¢å¼•ï¼ˆå…¨è¡¨æ‰«æï¼‰+ WHERE æ¡ä»¶ï¼ˆRecord Lockï¼‰

-- äº‹åŠ¡A
START TRANSACTION;
SELECT * FROM t WHERE name = 'C' FOR UPDATE;


name æ²¡æœ‰ç´¢å¼•ï¼ŒInnoDB åªèƒ½èµ°ä¸»é”®å…¨è¡¨æ‰«æã€‚
ğŸ”’ åŠ é”æƒ…å†µï¼š

    æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼ˆid=3ï¼‰ï¼ŒåŠ  Record Lock

    ä¸åŠ é—´éš™é”ï¼ˆå› ä¸ºæ˜¯é€šè¿‡ä¸»é”®ä¸€æ¡æ¡åˆ¤æ–­ï¼‰

5.  ç¤ºä¾‹ 5ï¼šå”¯ä¸€ç´¢å¼• + èŒƒå›´æŸ¥æ‰¾ï¼ˆNext-Key Lockï¼‰

-- äº‹åŠ¡A
START TRANSACTION;
SELECT * FROM t WHERE id > 2 AND id < 4 FOR UPDATE;


ç„¶æ˜¯å”¯ä¸€ç´¢å¼•ï¼ˆä¸»é”®ï¼‰ï¼Œä½†è¿™æ˜¯èŒƒå›´æŸ¥æ‰¾ï¼Œä¼šåŠ  Next-Key Lockã€‚
ğŸ”’ åŠ é”èŒƒå›´ï¼š

    (2,3]ï¼šé”ä½ id=3 å’Œ gap

    (3,4]ï¼šé”ä½ id=4 å’Œ gap


6. ç¤ºä¾‹ 6ï¼šauto_increment åˆ—ä¸Šçš„é—´éš™é”ï¼ˆæ’å…¥æ„å›¾é”ï¼‰

-- è¡¨ç»“æ„ä¸åŒï¼š
CREATE TABLE auto_t (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(10)
) ENGINE=InnoDB;

-- å½“å‰æœ€å¤§ id = 5
-- äº‹åŠ¡A
START TRANSACTION;
INSERT INTO auto_t(name) VALUES ('A');

ğŸ”’ åŠ é”ï¼š

    æ’å…¥æ„å›¾é”ï¼šåŠ åœ¨ (5, +âˆ) çš„ gap ä¸Šï¼Œç”¨äºç”Ÿæˆä¸‹ä¸€ä¸ª AUTO_INCREMENT å€¼ï¼ˆMySQL ä½¿ç”¨äº†æ’å…¥æ„å›¾é” + AUTO-INCæœºåˆ¶ï¼‰

è¿™æ˜¯ å¦ä¸€ç§é—´éš™é”åº”ç”¨åœºæ™¯ã€‚

### Insert Intention Lock ï¼ˆæ’å…¥æ„å‘é”ï¼‰

InnoDB ä¸ºäº†åè°ƒæ’å…¥æ“ä½œä¹‹é—´çš„å¹¶å‘ï¼Œåœ¨ ç­‰å¾… gap lock æ—¶è‡ªåŠ¨åŠ ä¸Šçš„ä¸€ç§æ„å‘é”ã€‚
æ˜¯ ä¸€ç§ç‰¹æ®Šçš„ gap lockï¼Œä½†æœ¬è´¨ä¸Šæ˜¯éé˜»å¡çš„æ’å…¥å£°æ˜ï¼Œä¸ä¼šå†²çªï¼Œä¹Ÿä¸ä¼šé˜»æ­¢å…¶ä»–æ’å…¥ã€‚

å‡è®¾ä¸€ä¸ªæŸ¥è¯¢æ“ä½œé”ä½äº†ï¼ˆ10ï¼Œ20ï¼‰è¿™ä¸ªé—´éš™ï¼Œä½†æ˜¯ä¸€ä¸ªæ’å…¥æ“ä½œæƒ³æ’å…¥ä¸€æ¡15çš„æ•°æ®ï¼ŒInnoDBå°±ä¼šè‡ªåŠ¨åŠ ä¸Šâ€œæ’å…¥æ„å‘é”â€ï¼Œè¡¨ç¤ºè¦åœ¨ï¼ˆ10ï¼Œ20ï¼‰è¿™ä¸ªgapæ’å…¥æ•°æ®ã€‚

å‡è®¾Aäº‹åŠ¡æƒ³æ’å…¥15ï¼ŒBäº‹åŠ¡æƒ³æ’å…¥16ï¼Œ äºŒè€…çš„æ’å…¥æ„å‘é”ï¼Œå¹¶ä¸ä¼šå†²çª
å‡è®¾Aäº‹åŠ¡æƒ³æ’å…¥15ï¼ŒBäº‹åŠ¡æƒ³æ’å…¥15ï¼Œ äºŒè€…çš„æ’å…¥æ„å‘é”ï¼Œä¹Ÿä¸ä¼šå†²çª

çœŸæ­£å†³å®šæ˜¯å¦â€œå†²çªâ€çš„ï¼Œä¸æ˜¯æ’å…¥æ„å‘é”ï¼Œè€Œæ˜¯ï¼š

    æ˜¯å¦æœ‰å…¶ä»–äº‹åŠ¡æŒæœ‰äº† gap lockï¼ˆé—´éš™é”ï¼‰ â†’ é˜»æ­¢æ’å…¥ï¼›

    æ˜¯å¦è¿åå”¯ä¸€çº¦æŸï¼ˆå¦‚ PRIMARY KEY æˆ– UNIQUEï¼‰ â†’ æ’å…¥å¤±è´¥æˆ–ç­‰å¾…ï¼›

    æ˜¯å¦å› ä¸ºäº‹åŠ¡ä¸²è¡ŒåŒ–è€Œç­‰å¾…é”é‡Šæ”¾ï¼ˆå¦‚é” waitï¼‰ã€‚




# ç´¢å¼•
## è¦†ç›–ç´¢å¼•

ç´¢å¼•è¦†ç›–æ˜¯æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œå®ƒæŒ‡çš„æ˜¯å½“ä¸€ä¸ªæŸ¥è¯¢å¯ä»¥ä»…é€šè¿‡ç´¢å¼•å°±èƒ½è·å–æ‰€éœ€çš„æ‰€æœ‰æ•°æ®ï¼Œè€Œæ— éœ€å›åˆ°æ•°æ®è¡¨ä¸­å»æŸ¥æ‰¾ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç´¢å¼•å·²ç»â€œè¦†ç›–â€äº†æŸ¥è¯¢æ‰€éœ€è¦çš„æ•°æ®ï¼Œå› æ­¤å¯ä»¥æ˜¾è‘—æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚

ç´¢å¼•è¦†ç›–çš„å·¥ä½œåŸç†

åœ¨ç†è§£ç´¢å¼•è¦†ç›–ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç™½ç´¢å¼•æœ¬èº«çš„ä½œç”¨ã€‚ç´¢å¼•æ˜¯å¸®åŠ©æ•°æ®åº“é«˜æ•ˆæ‰¾åˆ°æ•°æ®è¡Œçš„ä¸€ç§ç»“æ„ï¼Œç±»ä¼¼äºä¹¦æœ¬çš„ç›®å½•ã€‚å¦‚æœä¸€ä¸ªæŸ¥è¯¢æ‰€éœ€çš„æ•°æ®å·²ç»åœ¨ç´¢å¼•ä¸­ï¼Œæ•°æ®åº“å°±æ— éœ€å†å»æ•°æ®è¡Œä¸­æ£€ç´¢ï¼Œè¿™æ ·å°±å‡å°‘äº†I/Oæ“ä½œï¼Œæé«˜äº†æŸ¥è¯¢é€Ÿåº¦ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªæŸ¥è¯¢åªéœ€è¦æŸä¸ªå·²ç»è¢«ç´¢å¼•çš„åˆ—çš„æ•°æ®ï¼Œé‚£ä¹ˆè¿™ä¸ªç´¢å¼•å°±æ˜¯ä¸€ä¸ªè¦†ç›–ç´¢å¼•ã€‚

å¦‚ä½•å®ç°ç´¢å¼•è¦†ç›–

è¦å®ç°ç´¢å¼•è¦†ç›–ï¼Œé€šå¸¸çš„åšæ³•æ˜¯å°†æŸ¥è¯¢ä¸­æ¶‰åŠçš„æ‰€æœ‰åˆ—éƒ½åŒ…å«åœ¨ç´¢å¼•ä¸­ã€‚è¿™å¯ä»¥é€šè¿‡åˆ›å»ºå¤åˆç´¢å¼•æ¥å®ç°ï¼Œå³ä¸€ä¸ªç´¢å¼•åŒ…å«å¤šä¸ªåˆ—ã€‚ä¾‹å¦‚ï¼Œåœ¨MySQLä¸­ï¼Œå¦‚æœæˆ‘ä»¬å¯¹æŸ¥è¯¢ä¸­ä½¿ç”¨çš„åˆ—å»ºç«‹äº†ç´¢å¼•ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œè®¡åˆ’ä¸­çš„Extraå­—æ®µä¼šæ˜¾ç¤ºUsing indexï¼Œè¿™è¡¨æ˜æŸ¥è¯¢ä½¿ç”¨äº†ç´¢å¼•è¦†ç›–ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“æŸä¸ªæŸ¥è¯¢ä¼šé¢‘ç¹å‘ç”Ÿï¼Œä¸”æŸ¥è¯¢çš„åˆ—ä¸å¤šï¼Œé‚£ä¹ˆå¯ä»¥é’ˆå¯¹è¿™äº›åˆ—åˆ›å»ºä¸€ä¸ªå¤åˆç´¢å¼•ã€‚è¿™æ ·ï¼Œå½“æŸ¥è¯¢å‘ç”Ÿæ—¶ï¼Œæ•°æ®åº“å¯ä»¥ç›´æ¥ä½¿ç”¨ç´¢å¼•ä¸­çš„æ•°æ®ï¼Œè€Œä¸éœ€è¦å›è¡¨æŸ¥è¯¢ï¼Œä»è€Œæé«˜æŸ¥è¯¢æ€§èƒ½ã€‚

ç´¢å¼•è¦†ç›–çš„ä¼˜åŠ¿

ç´¢å¼•è¦†ç›–çš„ä¸»è¦ä¼˜åŠ¿åœ¨äºå®ƒé¿å…äº†å›è¡¨æŸ¥è¯¢ï¼Œè¿™æ˜¯ä¸€ç§æƒ…å†µï¼Œå…¶ä¸­æ•°æ®åº“éœ€è¦ä»éä¸»é”®ç´¢å¼•æ‰¾åˆ°ä¸»é”®ï¼Œç„¶åå†å›åˆ°ä¸»é”®ç´¢å¼•å»æ£€ç´¢å®Œæ•´çš„æ•°æ®è¡Œã€‚é€šè¿‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå¯ä»¥ç›´æ¥ä»éä¸»é”®ç´¢å¼•ä¸­è·å–æ‰€éœ€æ•°æ®ï¼Œå‡å°‘äº†æŸ¥è¯¢æ­¥éª¤å’ŒI/Oæ“ä½œï¼Œä»è€Œæé«˜äº†æŸ¥è¯¢æ•ˆç‡ã€‚

æ³¨æ„äº‹é¡¹

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰ç±»å‹çš„ç´¢å¼•éƒ½å¯ä»¥ç”¨äºç´¢å¼•è¦†ç›–ã€‚ä¾‹å¦‚ï¼Œå“ˆå¸Œç´¢å¼•ã€ç©ºé—´ç´¢å¼•å’Œå…¨æ–‡ç´¢å¼•ä¸å­˜å‚¨ç´¢å¼•åˆ—çš„å€¼ï¼Œå› æ­¤ä¸èƒ½ç”¨äºç´¢å¼•è¦†ç›–ã€‚åœ¨MySQLä¸­ï¼Œé€šå¸¸ä½¿ç”¨B-treeç´¢å¼•æ¥å®ç°ç´¢å¼•è¦†ç›–ã€‚

æ€»çš„æ¥è¯´ï¼Œç´¢å¼•è¦†ç›–æ˜¯æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–çš„æœ‰æ•ˆæ‰‹æ®µä¹‹ä¸€ã€‚åœ¨è®¾è®¡æ•°æ®åº“å’ŒæŸ¥è¯¢æ—¶ï¼Œåº”å½“è€ƒè™‘æ˜¯å¦å¯ä»¥åˆ©ç”¨ç´¢å¼•è¦†ç›–æ¥æé«˜æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§é‡æ•°æ®å’Œå¤æ‚æŸ¥è¯¢æ—¶ï¼Œç´¢å¼•è¦†ç›–çš„ä¼˜åŠ¿å°¤ä¸ºæ˜æ˜¾ã€‚

## mysqlçš„btree hash fulltext  rtreeç´¢å¼•æœ‰ä»€ä¹ˆåŒºåˆ«


B-Treeç´¢å¼•
    é»˜è®¤ç´¢å¼•ç±»å‹ï¼Œé€‚ç”¨äºç­‰å€¼æŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢ï¼ˆå¦‚>ã€<ã€BETWEENï¼‰ã€‚
    æ”¯æŒORDER BYæ’åºå’Œæœ€å·¦å‰ç¼€åŒ¹é…ï¼ˆè”åˆç´¢å¼•ï¼‰ã€‚
    é€‚ç”¨äºInnoDBå’ŒMyISAMå­˜å‚¨å¼•æ“ã€‚
Hashç´¢å¼•
    ä»…æ”¯æŒç­‰å€¼æŸ¥è¯¢ï¼ˆ=ã€INï¼‰ï¼Œä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢æˆ–æ’åºã€‚
    æŸ¥è¯¢é€Ÿåº¦æå¿«ï¼Œæ—¶é—´å¤æ‚åº¦æ¥è¿‘O(1)ã€‚
    ä»…Memoryå­˜å‚¨å¼•æ“æ˜¾å¼æ”¯æŒï¼ŒInnoDBçš„è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•æ˜¯éšå¼çš„ã€‚
Fulltextç´¢å¼•
    ä¸“ç”¨äºå…¨æ–‡æœç´¢ï¼Œæ”¯æŒæ–‡æœ¬å†…å®¹çš„æ¨¡ç³ŠåŒ¹é…ï¼ˆMATCH AGAINSTï¼‰ã€‚
    ä»…é€‚ç”¨äºMyISAMå’ŒInnoDBï¼ˆMySQL 5.6+ï¼‰ã€‚
    éœ€è¦åˆ†è¯å¤„ç†ï¼Œé€‚åˆå¤§æ–‡æœ¬å­—æ®µï¼ˆå¦‚æ–‡ç« å†…å®¹ï¼‰ã€‚
R-Treeç´¢å¼•
    ç”¨äºç©ºé—´æ•°æ®ç±»å‹ï¼ˆå¦‚GEOMETRYï¼‰ï¼Œæ”¯æŒåœ°ç†èŒƒå›´æŸ¥è¯¢ï¼ˆå¦‚MBRContainsï¼‰ã€‚
    ä»…MyISAMå­˜å‚¨å¼•æ“æ”¯æŒã€‚
    é€‚ç”¨äºGISåº”ç”¨ï¼ˆå¦‚åœ°å›¾åæ ‡æ£€ç´¢ï¼‰ã€‚

æ ¸å¿ƒå·®å¼‚ï¼š

    B-Treeé€šç”¨æ€§å¼ºï¼ŒHashé€Ÿåº¦å¿«ä½†åŠŸèƒ½å—é™ï¼ŒFulltexté’ˆå¯¹æ–‡æœ¬ï¼ŒR-Treeé’ˆå¯¹ç©ºé—´æ•°æ®ã€‚
    å­˜å‚¨å¼•æ“æ”¯æŒä¸åŒï¼Œéœ€æ ¹æ®åœºæ™¯é€‰æ‹©ã€‚
## ç´¢å¼•ä¸‹æ¨

ç´¢å¼•ä¸‹æ¨èƒ½å¤Ÿå‡å°‘äºŒçº§ç´¢å¼•åœ¨æŸ¥è¯¢æ—¶çš„å›è¡¨æ“ä½œï¼Œæé«˜æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå› ä¸ºå®ƒå°† Server å±‚éƒ¨åˆ†è´Ÿè´£çš„äº‹æƒ…ï¼Œäº¤ç»™å­˜å‚¨å¼•æ“å±‚å»å¤„ç†äº†ã€‚
è”åˆç´¢å¼•å½“é‡åˆ°èŒƒå›´æŸ¥è¯¢ (>ã€<) å°±ä¼šåœæ­¢åŒ¹é…



# æ—¥å¿—


# å­˜å‚¨ç»“æ„
æ¯”è¾ƒç»¼åˆï¼Œåç»­å†çœ‹

# å†…å­˜

## Statement-based replicationï¼ˆSBRï¼‰å¦‚ä½•ä¿è¯ä¸€è‡´ï¼Ÿ